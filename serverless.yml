service: notion-x-publisher

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-2
  environment:
    NOTION_API_KEY: ${env:NOTION_API_KEY}
    NOTION_DATABASE_ID: ${env:NOTION_DATABASE_ID}
    TWITTER_API_KEY: ${env:TWITTER_API_KEY}
    TWITTER_API_SECRET: ${env:TWITTER_API_SECRET}
    TWITTER_ACCESS_TOKEN: ${env:TWITTER_ACCESS_TOKEN}
    TWITTER_ACCESS_TOKEN_SECRET: ${env:TWITTER_ACCESS_TOKEN_SECRET}
    APIFY_API_TOKEN: ${env:APIFY_API_TOKEN}
    APIFY_TASK_ID: ${env:APIFY_TASK_ID}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    SLACK_WEBHOOK_URL: ${env:SLACK_WEBHOOK_URL}
    WEBHOOK_SECRET: ${env:WEBHOOK_SECRET}

plugins:
  - serverless-plugin-typescript
  - serverless-offline

package:
  individually: true
  patterns:
    - '!node_modules/.prisma/**'
    - '!node_modules/@prisma/client/node_modules/**'
    - '!node_modules/prisma/**'
    - '!tests/**'
    - '!coverage/**'
    - '!.git/**'

functions:
  # Webhook handler for manual draft processing via Notion button
  draftProcessorWebhook:
    handler: src/webhook.handler
    description: 'Handles webhook requests from Notion button to process draft tweets'
    events:
      - httpApi:
          path: /webhook
          method: post
    timeout: 30
    memorySize: 256
    environment:
      NOTION_API_KEY: ${env:NOTION_API_KEY}
      NOTION_DATABASE_ID: ${env:NOTION_DATABASE_ID}
      WEBHOOK_SECRET: ${env:WEBHOOK_SECRET}
      OPENAI_API_KEY: ${env:OPENAI_API_KEY}

  # Scheduled functions
  scheduledTweetPublisher:
    handler: src/functions/scheduler/index.handler
    description: 'Publishes tweets that are Ready To Publish on schedule'
    events:
      - schedule: rate(5 minutes)
    timeout: 60
    memorySize: 256

  scheduledDraftProcessor:
    handler: src/functions/ai-processor/index.handler
    description: 'Automatically processes draft tweets on schedule'
    events:
      - schedule: rate(30 minutes)
    timeout: 300
    memorySize: 1024

  scheduledScraper:
    handler: src/functions/scraper/index.handler
    description: 'Scrapes content on schedule'
    events:
      - schedule: rate(1 hour)
    timeout: 300
    memorySize: 512

custom:
  serverless-offline:
    httpPort: 4000
    lambdaPort: 4002 